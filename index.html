<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>FX CSV Viewer (ローカル5分足 + 取引)</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #111;
        color: #eee;
      }
      header {
        padding: 6px 12px;
        background: #222;
        border-bottom: 1px solid #333;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        font-size: 14px;
      }
      header input[type="file"] {
        font-size: 13px;
      }
      #status {
        font-size: 12px;
        opacity: 0.85;
      }
      #chart {
        width: 100%;
        height: calc(100vh - 60px);
      }
    </style>

    <!-- Lightweight Charts v3.1.5 -->
    <script src="https://unpkg.com/lightweight-charts@3.1.5/dist/lightweight-charts.standalone.production.js"></script>
  </head>

  <body>
    <header>
      <div>5分足CSV と 取引CSV を読み込んでチャートに表示</div>

      <label>
        5分足CSV:
        <input type="file" id="candleFile" accept=".csv" />
      </label>

      <label>
        取引CSV:
        <input type="file" id="tradeFile" accept=".csv" />
      </label>

      <div id="status">まず 5分足CSV を選択してください。</div>
    </header>

    <div id="chart"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chartContainer = document.getElementById("chart");
        const candleFileInput = document.getElementById("candleFile");
        const tradeFileInput = document.getElementById("tradeFile");
        const statusEl = document.getElementById("status");

        function setStatus(msg) {
          statusEl.textContent = msg;
        }

        // ---- チャートセットアップ ----------------------------------------
        const chart = LightweightCharts.createChart(chartContainer, {
          layout: {
            background: { type: "solid", color: "#111" },
            textColor: "#EEE",
          },
          grid: {
            vertLines: { color: "#222" },
            horzLines: { color: "#222" },
          },
          rightPriceScale: { borderColor: "#555" },
          timeScale: { borderColor: "#555" },
          width: chartContainer.clientWidth,
          height: chartContainer.clientHeight,
        });

        window.addEventListener("resize", () => {
          chart.applyOptions({
            width: chartContainer.clientWidth,
            height: chartContainer.clientHeight,
          });
        });

        const candleSeries = chart.addCandlestickSeries({
          upColor: "#26a69a",
          downColor: "#ef5350",
          borderUpColor: "#26a69a",
          borderDownColor: "#ef5350",
          wickUpColor: "#ccc",
          wickDownColor: "#ccc",
        });

        let candleData = null;

        // ---- 5分足CSV -> OHLC ---------------------------------------------
        function parseCandleCsv(csvText) {
          const lines = csvText.trim().split(/\r?\n/);
          if (lines.length < 2) throw new Error("足データの行がありません");

          const header = lines[0].split(",").map((h) => h.trim().toLowerCase());

          const idxTime = header.findIndex((h) => h.includes("time") || h.includes("日時") || h.includes("date"));
          const idxOpen = header.findIndex((h) => h.includes("open") || h.includes("始値"));
          const idxHigh = header.findIndex((h) => h.includes("high") || h.includes("高値"));
          const idxLow  = header.findIndex((h) => h.includes("low") || h.includes("安値"));
          const idxClose= header.findIndex((h) => h.includes("close") || h.includes("終値") || h.includes("close"));

          if (idxTime === -1 || idxOpen === -1 || idxHigh === -1 || idxLow === -1 || idxClose === -1) {
            throw new Error("5分足CSV のヘッダは time,open,high,low,close を含む必要があります");
          }

          const out = [];

          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(",");

            const tStr = (cols[idxTime] || "").trim();
            const oStr = (cols[idxOpen] || "").trim();
            const hStr = (cols[idxHigh] || "").trim();
            const lStr = (cols[idxLow]  || "").trim();
            const cStr = (cols[idxClose]|| "").trim();

            if (!tStr || !oStr || !hStr || !lStr || !cStr) continue;

            const ts = Date.parse(tStr.replace(/\//g, "-"));
            if (!Number.isFinite(ts)) continue;

            const open  = Number(oStr);
            const high  = Number(hStr);
            const low   = Number(lStr);
            const close = Number(cStr);

            if (![open, high, low, close].every(Number.isFinite)) continue;

            out.push({
              time: Math.floor(ts / 1000),
              open, high, low, close,
            });
          }

          if (out.length === 0) throw new Error("有効な足データがありません");
          out.sort((a, b) => a.time - b.time);
          return out;
        }

        // ---- あなたのFX CSV専用：CSV -> trades配列に変換 -------------------
        function parseTradeCsv(csvText) {
          const lines = csvText.trim().split(/\r?\n/);
          if (lines.length < 2) {
            throw new Error("取引データ行がありません");
          }

          const header = lines[0].split(",").map((h) => h.trim());

          const idxTime  = header.indexOf("約定日");
          const idxPair  = header.indexOf("通貨ペア");
          const idxSide  = header.indexOf("取引");
          const idxPrice = header.indexOf("決済価格(建単価)");

          if (idxTime === -1 || idxSide === -1 || idxPrice === -1) {
            throw new Error("取引CSV のヘッダに 約定日/決済価格(建単価)/取引 が必要です");
          }

          const trades = [];

          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = line.split(",");

            const timeStr  = (cols[idxTime]  || "").trim();
            const pairStr  = idxPair !== -1 ? (cols[idxPair] || "").trim() : "";
            const sideStr  = (cols[idxSide]  || "").trim();
            const priceStr = (cols[idxPrice] || "").trim();

            if (!timeStr || !priceStr) continue;

            // ここで通貨ペアを絞り込みたければ：
            // if (pairStr && pairStr !== "米ドル-円") continue;

            const ts = Date.parse(timeStr.replace(/\//g, "-"));
            const price = Number(priceStr);
            if (!Number.isFinite(ts) || !Number.isFinite(price)) continue;

            let side = "buy";
            if (sideStr.includes("売")) side = "sell";
            if (sideStr.includes("買")) side = "buy";

            trades.push({
              timeSec: Math.floor(ts / 1000),
              price,
              side,
            });
          }

          if (trades.length === 0) {
            throw new Error("有効な取引がありません");
          }

          trades.sort((a, b) => a.timeSec - b.timeSec);
          return trades;
        }

        // ---- 5分足CSVが選ばれたとき -------------------------------------
        candleFileInput.addEventListener("change", () => {
          const file = candleFileInput.files?.[0];
          if (!file) {
            setStatus("まず 5分足CSV を選択してください。");
            return;
          }

          const reader = new FileReader();
          reader.onload = () => {
            try {
              const text = reader.result;
              candleData = parseCandleCsv(String(text));
              candleSeries.setData(candleData);

              const from = candleData[0].time;
              const to   = candleData[candleData.length - 1].time;
              chart.timeScale().setVisibleRange({ from, to });

              setStatus(`5分足 ${candleData.length} 本を読み込みました。次に 取引CSV を選択してください。`);
            } catch (e) {
              console.error(e);
              setStatus("5分足CSV エラー: " + e.message);
            }
          };
          reader.readAsText(file, "shift-jis");  // 必要に応じて utf-8 に変更
        });

        // ---- 取引CSVが選ばれたとき ---------------------------------------
        tradeFileInput.addEventListener("change", () => {
          const file = tradeFileInput.files?.[0];
          if (!file) {
            setStatus("取引CSV を選択してください。");
            return;
          }
          if (!candleData) {
            setStatus("先に 5分足CSV を読み込んでください。");
            return;
          }

          const reader = new FileReader();
          reader.onload = () => {
            try {
              const text = reader.result;
              const trades = parseTradeCsv(String(text));

              const markers = trades.map((t) => ({
                time: t.timeSec,
                position: t.side === "buy" ? "belowBar" : "aboveBar",
                color: t.side === "buy" ? "#00ff00" : "#ff0000",
                shape: t.side === "buy" ? "arrowUp" : "arrowDown",
                text: t.side === "buy" ? "買" : "売",
              }));
              candleSeries.setMarkers(markers);

              const from = trades[0].timeSec - 60 * 60;
              const to   = trades[trades.length - 1].timeSec + 60 * 60;
              chart.timeScale().setVisibleRange({ from, to });

              setStatus(`5分足 ${candleData.length} 本 + 取引 ${trades.length} 件を表示しました。`);
            } catch (e) {
              console.error(e);
              setStatus("取引CSV エラー: " + e.message);
            }
          };
          reader.readAsText(file, "shift-jis");
        });
      });
    </script>
  </body>
</html>
