<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>FX CSV Viewer (ローカル5分足 + 取引)</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #111;
        color: #eee;
      }
      header {
        padding: 6px 12px;
        background: #222;
        border-bottom: 1px solid #333;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        font-size: 14px;
      }
      header input[type="file"] {
        font-size: 13px;
      }
      #status {
        font-size: 12px;
        opacity: 0.85;
      }
      #chart {
        width: 100%;
        height: calc(100vh - 60px);
      }
    </style>

    <!-- Lightweight Charts v3.1.5 -->
    <script src="https://unpkg.com/lightweight-charts@3.1.5/dist/lightweight-charts.standalone.production.js"></script>
  </head>

  <body>
    <header>
      <div>5分足CSV と 取引CSV を読み込んでチャートに表示</div>

      <label>
        5分足CSV:
        <input type="file" id="candleFile" accept=".csv" />
      </label>

      <label>
        取引CSV:
        <input type="file" id="tradeFile" accept=".csv" />
      </label>

      <div id="status">まず 5分足CSV を選択してください。</div>
    </header>

    <div id="chart"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chartContainer = document.getElementById("chart");
        const candleFileInput = document.getElementById("candleFile");
        const tradeFileInput = document.getElementById("tradeFile");
        const statusEl = document.getElementById("status");

        function setStatus(msg) {
          statusEl.textContent = msg;
        }

        // ---- チャートセットアップ ----------------------------------------
        const chart = LightweightCharts.createChart(chartContainer, {
          layout: {
            background: { type: "solid", color: "#111" },
            textColor: "#EEE",
          },
          grid: {
            vertLines: { color: "#222" },
            horzLines: { color: "#222" },
          },
          rightPriceScale: { borderColor: "#555" },
          timeScale: { borderColor: "#555" },
          width: chartContainer.clientWidth,
          height: chartContainer.clientHeight,
        });

        window.addEventListener("resize", () => {
          chart.applyOptions({
            width: chartContainer.clientWidth,
            height: chartContainer.clientHeight,
          });
        });

        const candleSeries = chart.addCandlestickSeries({
          upColor: "#26a69a",
          downColor: "#ef5350",
          borderUpColor: "#26a69a",
          borderDownColor: "#ef5350",
          wickUpColor: "#ccc",
          wickDownColor: "#ccc",
        });

        let candleData = null;

        // ---- 5分足CSV -> OHLC ---------------------------------------------
        // ---- MT系の "<DATE>\t<TIME>\t<OPEN>..." 形式をパース ----------------------
// ---- MT形式 "<DATE>\t<TIME>\t<OPEN>..." をパース ----------------------
function parseCandleCsv(csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  if (lines.length < 2) throw new Error("足データの行がありません");

  // 1行を「前後のダブルクォートを削除 → タブ or カンマで分割」
  const splitRow = (line) => {
    let s = line.trim();
    if (!s) return [];
    if (s.startsWith('"') && s.endsWith('"')) {
      s = s.slice(1, -1);
    }
    return s.split(/[\t,]+/);
  };

  // 1行目（ヘッダ）
  const headerCells = splitRow(lines[0]);
  const header = headerCells.map((h) =>
    h.replace(/[<>"\s]/g, "").toUpperCase()
  );

  const idxDate = header.findIndex((h) => h.includes("DATE"));
  const idxTime = header.findIndex((h) => h.includes("TIME"));
  const idxOpen = header.findIndex((h) => h.includes("OPEN"));
  const idxHigh = header.findIndex((h) => h.includes("HIGH"));
  const idxLow = header.findIndex((h) => h.includes("LOW"));
  const idxClose = header.findIndex((h) => h.includes("CLOSE"));

  if (
    idxDate === -1 ||
    idxTime === -1 ||
    idxOpen === -1 ||
    idxHigh === -1 ||
    idxLow === -1 ||
    idxClose === -1
  ) {
    throw new Error(
      "5分足CSV のヘッダに <DATE><TIME><OPEN><HIGH><LOW><CLOSE> が必要です"
    );
  }

  const out = [];

  for (let i = 1; i < lines.length; i++) {
    const cells = splitRow(lines[i]);
    if (!cells.length) continue;

    const dateField = (cells[idxDate] || "").trim();
    const timeField = (cells[idxTime] || "").trim();
    const openStr = (cells[idxOpen] || "").trim();
    const highStr = (cells[idxHigh] || "").trim();
    const lowStr = (cells[idxLow] || "").trim();
    const closeStr = (cells[idxClose] || "").trim();

    if (!dateField || !timeField || !openStr || !highStr || !lowStr || !closeStr)
      continue;

    // dateField の中から "YYYY.MM.DD" を探す（余計な数字が付いていてもOK）
    const m = dateField.match(/(\d{4})\.(\d{1,2})\.(\d{1,2})/);
    if (!m) continue;
    let [, year, month, day] = m;
    if (month.length === 1) month = "0" + month;
    if (day.length === 1) day = "0" + day;

    // "YYYY-MM-DDTHH:MM:SS" にして Date.parse
    const iso = `${year}-${month}-${day}T${timeField}`;
    const ts = Date.parse(iso);
    if (!Number.isFinite(ts)) continue;

    const open = Number(openStr);
    const high = Number(highStr);
    const low = Number(lowStr);
    const close = Number(closeStr);
    if (![open, high, low, close].every(Number.isFinite)) continue;

    out.push({
      time: Math.floor(ts / 1000), // 秒
      open,
      high,
      low,
      close,
    });
  }

  if (out.length === 0) {
    throw new Error("有効な足データがありません");
  }

  out.sort((a, b) => a.time - b.time);
  return out;
}



        // ---- あなたのFX CSV専用：CSV -> trades配列に変換 -------------------
        function parseTradeCsv(csvText) {
          const lines = csvText.trim().split(/\r?\n/);
          if (lines.length < 2) {
            throw new Error("取引データ行がありません");
          }

          const header = lines[0].split(",").map((h) => h.trim());

          const idxTime  = header.indexOf("約定日");
          const idxPair  = header.indexOf("通貨ペア");
          const idxSide  = header.indexOf("取引");
          const idxPrice = header.indexOf("決済価格(建単価)");

          if (idxTime === -1 || idxSide === -1 || idxPrice === -1) {
            throw new Error("取引CSV のヘッダに 約定日/決済価格(建単価)/取引 が必要です");
          }

          const trades = [];

          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = line.split(",");

            const timeStr  = (cols[idxTime]  || "").trim();
            const pairStr  = idxPair !== -1 ? (cols[idxPair] || "").trim() : "";
            const sideStr  = (cols[idxSide]  || "").trim();
            const priceStr = (cols[idxPrice] || "").trim();

            if (!timeStr || !priceStr) continue;

            // ここで通貨ペアを絞り込みたければ：
            // if (pairStr && pairStr !== "米ドル-円") continue;

            const ts = Date.parse(timeStr.replace(/\//g, "-"));
            const price = Number(priceStr);
            if (!Number.isFinite(ts) || !Number.isFinite(price)) continue;

            let side = "buy";
            if (sideStr.includes("売")) side = "sell";
            if (sideStr.includes("買")) side = "buy";

            trades.push({
              timeSec: Math.floor(ts / 1000),
              price,
              side,
            });
          }

          if (trades.length === 0) {
            throw new Error("有効な取引がありません");
          }

          trades.sort((a, b) => a.timeSec - b.timeSec);
          return trades;
        }

        // ---- 5分足CSVが選ばれたとき -------------------------------------
        candleFileInput.addEventListener("change", () => {
          const file = candleFileInput.files?.[0];
          if (!file) {
            setStatus("まず 5分足CSV を選択してください。");
            return;
          }

          const reader = new FileReader();
          reader.onload = () => {
            try {
              const text = reader.result;
              candleData = parseCandleCsv(String(text));
              candleSeries.setData(candleData);

              const from = candleData[0].time;
              const to   = candleData[candleData.length - 1].time;
              chart.timeScale().setVisibleRange({ from, to });

              setStatus(`5分足 ${candleData.length} 本を読み込みました。次に 取引CSV を選択してください。`);
            } catch (e) {
              console.error(e);
              setStatus("5分足CSV エラー: " + e.message);
            }
          };
          reader.readAsText(file, "shift-jis");  // 必要に応じて utf-8 に変更
        });

        // ---- 取引CSVが選ばれたとき ---------------------------------------
        tradeFileInput.addEventListener("change", () => {
          const file = tradeFileInput.files?.[0];
          if (!file) {
            setStatus("取引CSV を選択してください。");
            return;
          }
          if (!candleData) {
            setStatus("先に 5分足CSV を読み込んでください。");
            return;
          }

          const reader = new FileReader();
          reader.onload = () => {
            try {
              const text = reader.result;
              const trades = parseTradeCsv(String(text));

              const markers = trades.map((t) => ({
                time: t.timeSec,
                position: t.side === "buy" ? "belowBar" : "aboveBar",
                color: t.side === "buy" ? "#00ff00" : "#ff0000",
                shape: t.side === "buy" ? "arrowUp" : "arrowDown",
                text: t.side === "buy" ? "買" : "売",
              }));
              candleSeries.setMarkers(markers);

              const from = trades[0].timeSec - 60 * 60;
              const to   = trades[trades.length - 1].timeSec + 60 * 60;
              chart.timeScale().setVisibleRange({ from, to });

              setStatus(`5分足 ${candleData.length} 本 + 取引 ${trades.length} 件を表示しました。`);
            } catch (e) {
              console.error(e);
              setStatus("取引CSV エラー: " + e.message);
            }
          };
          reader.readAsText(file, "shift-jis");
        });
      });
    </script>
  </body>
</html>
